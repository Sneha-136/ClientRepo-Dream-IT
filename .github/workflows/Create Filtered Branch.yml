# ============================================
# CONFIGURATION - EDIT ONLY THIS SECTION
# ============================================

name: Create Filtered Branch

# Run manually only
on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to filter from'
        required: true
        default: 'main'
      new_branch:
        description: 'Name for the new filtered branch'
        required: true
        default: 'filtered-branch'
      folders_to_keep:
        description: 'Comma-separated list of folders to keep (e.g., BusinessCentral,Shopify)'
        required: true
        default: 'BusinessCentral,Shopify'

# ============================================
# WORKFLOW CODE - DON'T EDIT BELOW
# ============================================

jobs:
  create-filtered-branch:
    runs-on: ubuntu-latest
    
    steps:
    # Checkout repository
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.inputs.source_branch }}
        fetch-depth: 0
        token: ${{ secrets.PAT_GITHUB }}

    # Configure Git
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"

    # Create new branch
    - name: Create new branch
      run: |
        echo "üåø Creating branch: ${{ github.event.inputs.new_branch }}"
        git checkout -b ${{ github.event.inputs.new_branch }}

    # Filter folders - Keep only specified folders
    - name: Filter folders
      run: |
        echo "============================================"
        echo "üìÇ Creating Filtered Branch"
        echo "============================================"
        echo ""
        echo "‚úÖ Folders to include in new branch: ${{ github.event.inputs.folders_to_keep }}"
        echo "‚ÑπÔ∏è  Note: Main branch will NOT be modified - only the new branch"
        echo ""
        
        # Convert comma-separated list to array
        IFS=',' read -ra FOLDERS <<< "${{ github.event.inputs.folders_to_keep }}"
        
        # Display folders that will be included
        echo "üìÅ Checking specified folders:"
        for folder in "${FOLDERS[@]}"; do
            folder=$(echo "$folder" | xargs)
            if [ -d "$folder" ]; then
                echo "   ‚úì $folder/ (found)"
            else
                echo "   ‚úó $folder/ (NOT FOUND - check spelling!)"
            fi
        done
        echo ""
        
        # Get all files in repository
        all_files=$(git ls-files)
        
        # Counter for kept files
        kept_count=0
        
        # List files that will be kept
        echo "üìÑ Files being added to new branch:"
        echo ""
        for file in $all_files; do
            keep_file=false
            
            # Check if file is in one of our folders to keep
            for folder in "${FOLDERS[@]}"; do
                folder=$(echo "$folder" | xargs)
                # Check if file is INSIDE the folder (must start with folder/ not just folder)
                if [[ $file == "$folder/"* ]]; then
                    keep_file=true
                    kept_count=$((kept_count + 1))
                    echo "   ‚úì $file"
                    break
                fi
            done
            
            # Remove file from new branch if not in keep list
            if [ "$keep_file" = false ]; then
                git rm "$file" 2>/dev/null || true
            fi
        done
        
        echo ""
        echo "üìä Summary:"
        echo "   ‚Ä¢ Total files in new branch: $kept_count"
        echo ""
        echo "‚úÖ Branch filtering complete!"

    # Show what's left
    - name: Show remaining structure
      run: |
        echo ""
        echo "üìÇ Remaining folder structure:"
        echo "============================================"
        ls -laR
        echo ""

    # Commit changes
    - name: Commit changes
      run: |
        echo "üíæ Committing changes to new branch..."
        git status
        if git diff --cached --quiet; then
          echo "‚ö†Ô∏è  No changes to commit (all files were kept)"
        else
          git commit -m "Created filtered branch with only: ${{ github.event.inputs.folders_to_keep }}" || echo "No changes to commit"
        fi

    # Push branch
    - name: Push new branch
      run: |
        echo "üöÄ Pushing branch: ${{ github.event.inputs.new_branch }}"
        git push origin ${{ github.event.inputs.new_branch }} --force
