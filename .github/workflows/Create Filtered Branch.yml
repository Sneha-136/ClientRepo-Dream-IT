# ============================================
# CONFIGURATION - EDIT ONLY THIS SECTION
# ============================================

name: Create Isolated Filtered Branch

# Run manually only
on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to filter from'
        required: true
        default: 'main'
      new_branch:
        description: 'Name for the new filtered branch'
        required: true
        default: 'filtered-branch'
      folders_to_keep:
        description: 'Comma-separated EXACT folder names (e.g., BusinessCentral,Shopify)'
        required: true
        default: 'BusinessCentral,Shopify'

# ============================================
# WORKFLOW CODE - DON'T EDIT BELOW
# ============================================

jobs:
  create-isolated-filtered-branch:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout repository with minimal history
    # Why: We don't need full history since we're creating a completely new isolated branch
    - name: Checkout source code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.inputs.source_branch }}
        fetch-depth: 1  # Only get latest commit, not full history
        token: ${{ secrets.PAT_GITHUB }}

    # Step 2: Configure Git identity
    # Why: Required for making commits
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"

    # Step 3: Create ORPHAN branch (completely disconnected from main)
    # Why: Orphan branches have NO shared history with main, making merge impossible
    - name: Create orphan branch (isolated from main)
      run: |
        echo "============================================"
        echo "ðŸŒ¿ Creating ISOLATED branch"
        echo "============================================"
        echo ""
        echo "Creating orphan branch: ${{ github.event.inputs.new_branch }}"
        echo "This branch will have NO connection to ${{ github.event.inputs.source_branch }}"
        echo "Pull requests will be automatically impossible due to no shared history"
        echo ""
        
        # Create orphan branch - this has NO parent commits from any branch
        git checkout --orphan ${{ github.event.inputs.new_branch }}

    # Step 4: Remove ALL files from staging
    # Why: Orphan branch starts with all files staged, we need clean slate
    - name: Clear all files from staging
      run: |
        echo "ðŸ—‘ï¸  Removing all files from staging area..."
        git rm -rf . 2>/dev/null || true
        echo "âœ… Staging area cleared"

    # Step 5: Re-checkout ONLY the specified folders from source branch
    # Why: We only want specific folders, nothing else
    - name: Copy only specified folders from source
      run: |
        echo "============================================"
        echo "ðŸ“‚ Copying EXACT folders from source branch"
        echo "============================================"
        echo ""
        
        # Convert comma-separated list to array
        IFS=',' read -ra FOLDERS <<< "${{ github.event.inputs.folders_to_keep }}"
        
        # Validate and copy each folder
        echo "ðŸ“ Folders to copy:"
        for folder in "${FOLDERS[@]}"; do
            folder=$(echo "$folder" | xargs)  # Trim whitespace
            
            # Check if folder exists in source branch
            if git ls-tree -r ${{ github.event.inputs.source_branch }} --name-only | grep -q "^${folder}/"; then
                echo "   âœ“ Copying: $folder/"
                
                # Checkout this specific folder from source branch
                git checkout ${{ github.event.inputs.source_branch }} -- "$folder/" 2>/dev/null || {
                    echo "   âš ï¸  Warning: Could not copy $folder/"
                }
            else
                echo "   âœ— NOT FOUND: $folder/ (skipping)"
            fi
        done
        echo ""
        echo "âœ… Folder copy complete"

    # Step 6: Verify what we have
    # Why: Show user exactly what's in the new branch
    - name: Show copied structure
      run: |
        echo ""
        echo "ðŸ“‚ Files in new isolated branch:"
        echo "============================================"
        if [ -z "$(ls -A)" ]; then
            echo "âš ï¸  WARNING: No files copied! Check folder names."
        else
            # Show tree structure
            find . -type f -not -path './.git/*' | sort | while read file; do
                echo "   âœ“ $file"
            done
        fi
        echo ""
        echo "ðŸ“Š Summary:"
        file_count=$(find . -type f -not -path './.git/*' | wc -l)
        echo "   â€¢ Total files: $file_count"
        echo ""

    # Step 7: Create initial commit on orphan branch
    # Why: Orphan branch needs at least one commit to exist
    - name: Create initial isolated commit
      run: |
        echo "ðŸ’¾ Creating initial commit on isolated branch..."
        echo ""
        
        # Add all files
        git add .
        
        # Check if there are files to commit
        if git diff --cached --quiet; then
            echo "âŒ ERROR: No files to commit!"
            echo "Check that folder names match exactly (case-sensitive)"
            exit 1
        else
            # Create commit with clear message
            git commit -m "Initial commit: Filtered branch - Folders: ${{ github.event.inputs.folders_to_keep }} | Source: ${{ github.event.inputs.source_branch }} | Type: ORPHAN (isolated) | Created: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            
            echo "âœ… Initial commit created"
        fi

    # Step 8: Push the isolated branch (Make branch available in remote repository)
    - name: Push isolated branch to remote
      run: |
        echo "============================================"
        echo "ðŸš€ Pushing isolated branch to remote"
        echo "============================================"
        echo ""
        
        # Force push to create/overwrite the branch
        git push origin ${{ github.event.inputs.new_branch }} --force
        
        echo ""
        echo "âœ… SUCCESS!"
        echo "============================================"
        echo "ðŸ“‹ Branch Details:"
        echo "   â€¢ Name: ${{ github.event.inputs.new_branch }}"
        echo "   â€¢ Type: Orphan (isolated from all other branches)"
        echo "   â€¢ Contains: ${{ github.event.inputs.folders_to_keep }}"
        echo "   â€¢ Source: ${{ github.event.inputs.source_branch }}"
        echo ""
        echo "ðŸ”’ Branch Protection:"
        echo "   â€¢ No shared history with main"
        echo "   â€¢ Cannot create pull requests to main"
        echo "   â€¢ Completely isolated branch"
        echo ""
        echo "âš ï¸  IMPORTANT:"
        echo "   This branch is ISOLATED and cannot be merged back to main"
        echo "   It exists as a separate line of development"
        echo "============================================"

    # Step 9: Create branch protection rule via GitHub API (optional but recommended)
    # Why: Extra safety to prevent accidental merges
    - name: Add branch protection (prevent merges to main)
      continue-on-error: true  # Don't fail workflow if this step fails
      run: |
        echo ""
        echo "ðŸ”’ Attempting to add branch protection..."
        
        # Note: This requires PAT with repo permissions
        # You can also set this manually in GitHub Settings > Branches
        
        curl -X PUT \
          -H "Authorization: token ${{ secrets.PAT_GITHUB }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/branches/${{ github.event.inputs.new_branch }}/protection" \
          -d '{
            "required_status_checks": null,
            "enforce_admins": false,
            "required_pull_request_reviews": null,
            "restrictions": null,
            "allow_force_pushes": true,
            "allow_deletions": false
          }' 2>/dev/null || echo "â„¹ï¸  Could not set branch protection via API (this is optional)"
        
        echo ""
        echo "â„¹ï¸  For additional protection, manually configure in:"
        echo "   Settings > Branches > Branch protection rules"
